--- 
title: "Interactive data visualization"
author: "John D. Lee"
date: "`r Sys.Date()`"
output: pdf_document
cover-image: images/Minard_timeline_map.png
bibliography:
- vis.bib
- book.bib
- packages.bib
description: A book of ggplot examples
documentclass: krantz
always_allow_html: yes
github-repo: jdlee/ggplot-examples
graphics: yes
link-citations: yes
lof: yes
lot: yes
colorlinks: yes
site: bookdown::bookdown_site
biblio-style: apalike
---

# install the packages needed by this book; you fill out c(), e.g. c('ggplot2', 'dplyr')

Placeholder


## Why read this book {-}
## Structure of the book {-}
## Software information and conventions {-}
## Acknowledgments {-}

<!--chapter:end:index.Rmd-->

# About the Author {-}

John D. Lee is a professor in the Department of Industrial and Systems Engineering at the University of Wisconsin-Madison. He has investigated the issues of human-automation interaction, particularly trust inautomation, for over 20 years. More specifically, his research considers trust and acceptance, as well as issues of distraction and engagement. He helped to edit the Handbook of Cognitive Engineering, which focusses on human interaction with increasingly autonomous systems. He is also a co-author of a popular textbook: Designing for People: An introduction to human factors engineering (http://designing4people.com).



<!--chapter:end:00-author.Rmd-->


# Introduction: Purposes, questions, and audiences {#Introduction}

Placeholder


## Seeing meaning rather than numbers
## Seeing more than summary statistics 
## Purpose and audience of visualizations
## What question to answer?
## Storytelling with graphics
## Data
## Read data from website
## Happiness
## Chocolate
## Police
## 2535 observations, Age, gender, how armed, state, threat, body cameraAll factors

<!--chapter:end:01-introduction.Rmd-->


# Visualization types and principles {#Principles}

Placeholder


#### Icons of graph type for common comparisons
## Set default and create data
## Create data
#### Association: Scatterplot ####
#### Fluctuation: Timeline ####
#### Distribution: Dotplot, Histogram, Density, Model Density ####
#### Proportion: Stacked bar ####
#### Comparison: Boxplot ####
#### Contribution: pareto plot  ####
#### Connection: Network diagram ####
#### Hiearchy: dendrogram  ####
#### Combined plots ####
## Pairing questions and graph types
## Percpetual processes to be supported: Comparison, Detection, Pattern identification
### Comparison
### Detection
### Pattern identification
## Principles from general to specific
### Identify audience, story, and key relationships (Few)
### Focus attention and organize reading
### Annotate to show cause and explain why
### Concrete details engage and are memorable
### Enable comparisons and put data in context 
### Map types of variables to graph features
### Ensure proximity compatibility
### Legibility and consistency
### Maximize data/ink ratio 
### Manage clutter with grouping and layering 
## Overview of examples

<!--chapter:end:02-principles.Rmd-->

\cleardoublepage 

# Association--scatterplots{#Association}

## Basic elements of the grammar of graphics

Table:(\#tab:test) Summary of ggplot element.

ggplot element     Description
-------------      ---------
Data	             ggplot uses a dataframe as input (e.g., data = mtcars.data)
Geoms		           geometric element (e.g., geom_point, geom_bar)
Mapping	           links data variables to aesthetic dimensions (aes)	(e.g., aes(x = cyl, y = mpg))
Setting		         specifies value of aesthetic dimension directly	(e.g., colour = “blue”)
Layers	           add components to base plot, most often	geoms (additional layers added with  “+”)
Stats		           statistical summary, such as density or count; each geom has a default statistic
Position	         adjusts the location of the plotted geom
Annotations        text and graphical overlays 
Coordinate system  Cartesian, polar or small multiple facets
Themes	           sets of plot parameters (e.g., font, background)



## Simple scatterplot 
The simplest plot must include data, aesthetic mapping, and geom a geometric element. The data must be organized with each observation as a row and each variable as a column. For a scatterplot the geometric element is a point, and the aesthetic mapping links variables to properties of the geometric element. For a scatterplot this would be the x and y position of the point. the the point the x and y position must be specified, but other properties, such as color, size, alpha level, and shape, can be mapped to variables. These properties of the geometric element can also be set to specific values, such as specifying the color of the point.

Figure \@ref(fig:simple-scatterplot) shows the ggplot2 code and associated scatterplot. The equation used to specify the plot implicitly specifies the values by their position, such as data being identifed as following "ggplot(".  The following speciifcations are equivalent:

``
ggplot(data = mtcars.df, mapping = aes(x = wt, y = mpg)) +
  geom_point(colour = "darkblue")
  
ggplot(mtcars.df, aes(wt, mpg)) +
  geom_point(colour = "darkblue")
``


```{r, simple-scatterplot, message=FALSE}

library(tidyverse)

mtcars.df = mtcars

ggplot(data = mtcars.df, mapping = aes(x = wt, y = mpg)) +
  geom_point(colour = "darkblue")

```

A powerful feature of ggplot2 is the abilty to add layers of geometric elements to a plot. Each layer can have its own data, mapping of aesthetic properties, and setting of aesthetic properties. The data and mapping specified in the base plot statement--"ggplot(data = mtcars.df, mapping = aes(x = wt, y = mpg))"--are global and apply to all layers, but can overridden by the any mappings specific to a layer. 
Figure \@ref(fig:scatterplot-layering) shows a layer of red circles based on a subset of the data.



```{r, scatterplot-layering}
fourcyl.mtcars.df = mtcars.df %>% filter(cyl==4)

ggplot(data = mtcars.df, mapping = aes(x = wt, y = mpg)) +
  geom_point(colour = "darkblue") + 
  geom_point(data = fourcyl.mtcars.df, colour = "red", shape = 21, size = 4)
  
  

```



## Scatterplot with additional mappings
The scatterplot typically maps variables to the x and y position of the points, but ggplot allows for other mappings.  Figure \@ref(fig:scatterplot-mapping) shows mapping variables to the fill and size of the points. The shape, stroke, and color of the points are set to values they could also be mapped, which could quickly overload the graph. Note that only shapes 21-25 in Figure \@ref(fig:symbols) can include fill and stroke, with the other symbols color determines the color of the whole symbol not just the border.

```{r, scatterplot-mapping, cache=TRUE}
ggplot(data = mtcars, mapping = aes(x = wt, y = mpg, fill = hp, size = 1/qsec)) + 
  geom_point(shape = 21, colour = "darkred", stroke = 2.) 
```


```{r, symbols, echo=FALSE, cache=TRUE}

symbol.plot = ggplot(data = data.frame(x = c(0: 25)), aes(x = x, y = x, shape = x)) + 
  geom_point(size = 8) +
  scale_shape_identity() +
  facet_wrap(~ x, scales = 'free') + 
  theme_void()

line.plot = ggplot(data=data.frame(x=c(1:6))) + 
  geom_hline(size=2, aes(yintercept=x, linetype=x)) +
  scale_linetype_identity() +
  xlim(c(0,100)) +
  facet_wrap(~ x, ncol = 2, scales = 'free')+
  theme_void()

ggarrange(symbol.plot, line.plot, 
nrow=1, ncol = 2)

```





## Scatterplot with linear and loess fit
The layers can include geometric elements beyond geom_point. Perhapts the most useful geoms to add to a scatterplot is a curve fit. Figure \@ref(fig:scatterplot-smooth) shows a simple scatterplot with two cruve fits.  The loess fit shows a smooth fit that indicates non-linar trends, and the blue line shows a linear regeression. The loess line highligths areas in the data that deviate from a linear relationship shown by the blue line. All three layers inherit the same x and y mapping from the ggplot base layer. 

When building a plot each layer is placed on top of the preceding layer, such that the last layer lies on top of all the others.  With Figure \@ref(fig:scatterplot-smooth), the points are on the bottom and the light blue line is on top of the gray loess line.

Table \@ref(tab:geoms) shows the full set of possible geometric elements that can be used to create graphs, the following chapters describe many of these.

Note  the smooth fit geoms include additional settings for the method and whether the line should include a standard error.

```{r, scatterplot-smooth}

ggplot(data = mtcars.df, aes(x = wt, y = mpg)) +
  geom_point(colour = "darkblue") +
  geom_smooth(method = "loess", se = FALSE, colour = "darkgrey") + 
  geom_smooth(method = "lm", fill = "lightblue")

```

```{r, geoms, echo=FALSE}
library(kableExtra)
knitr::kable(ls(pattern = '^geom_', env = as.environment('package:ggplot2')))
# TODO indicate what chapter will cover each with link and icon
# ggplot2:::.all_aesthetics
```


## Global and local regression 

```{r,, scatterplot-globallocal}
ggplot(data = mtcars.df, aes(x = wt, y = mpg)) +
    geom_smooth(method = lm, colour = "darkgrey", size = .5) +
  geom_point(aes(colour = as.factor(cyl))) +
  geom_smooth(aes(colour = as.factor(cyl)), method = lm, se = FALSE)

```


## Quantile regression and other functional relationships
Often the question the graph is meant to answer is not about the central tendency, but about the likelihood of relatively extreme values, such as the 25th and 75th percentiles.
```{r, scatterplot-quantile}
ggplot(data = mtcars.df, aes(x = wt, y = mpg)) +
    geom_smooth(method = lm, colour = "darkgrey", size = .5) +
  geom_point() +
  geom_quantile(quantiles = c(.25, .75))

```


## Scatterplot with regression equation and marginal distributions
Scatterplot augmented with marginal distributions, regression equation, and Tufte-inspired range frame.

Marginal distributions show that a 1-D scatterplot is a histogram and that a 2-d histogram is a scatterplot. Chapter \@ref(Distribution) describes such plots in detail.

Chapter \@ref(Polishing) shows how to add annotations, such as the equation.

Derived from: 
http://t-redactyl.io/blog/2016/05/creating-plots-in-r-using-ggplot2-part-11-linear-regression-plots.html

```{r, scatterplot-marginal}
library(ggthemes)
library(ggExtra) # For marginal histograms


equation = function(x) {
  lm_coef <- list(a = round(coef(x)[1], digits = 2),
                  b = round(coef(x)[2], digits = 2),
                  r2 = round(summary(x)$r.squared, digits = 2));
  lm_eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(R)^2~"="~r2,lm_coef)
  as.character(as.expression(lm_eq));                 
}

mtcars.df = mtcars
fit = lm(mpg~wt, data = mtcars.df)

p = ggplot(mtcars.df, aes(x=wt, y=mpg)) + 
  geom_point(colour = "darkblue") + 
  geom_smooth(method=lm, se=FALSE) +
  annotate("text", x = 4, y = 30, label = equation(fit), parse = TRUE) +
  geom_rangeframe() + # Requires ggthemes 
  theme_minimal()

p = ggMarginal(p, type = "histogram")
p

```




## Categorical scatterplot
```{r, scatterplot-categorical, cache=TRUE}
mtcars.df = mtcars
mtcars.df$gear = as.factor(mtcars.df$gear)
mtcars.df$am = as.factor(mtcars.df$am)

ggplot(mtcars.df, aes(gear, am)) + 
  geom_count()
 
 ggplot(mtcars.df, aes(gear, am)) + 
  geom_jitter(width = 0.075, height = 0.075) 
  
s.mtcars.df = mtcars.df %>% group_by(gear, am) %>% summarise(count = n())

ggplot(s.mtcars.df, aes(gear, am)) + 
  geom_tile(aes(fill = count))

```


## Table lens
Table lens serves a similar purpose to the scatterplot but might be more familiar and focusses attention on individual variables and individual cases. Chapter \@ref(Tables) provides more detail on this technique.

```{r, table_lens, echo=FALSE, message=FALSE}
library(DT)
sub.mtcars.df = mtcars.df %>% 
  dplyr::select(mpg, wt) %>% 
  rownames_to_column("name") 

datatable(sub.mtcars.df) %>% 
  formatStyle(names(sub.mtcars.df[, 2:3]),
  background = styleColorBar(range(sub.mtcars.df[, 2:3]), 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')
  
```


## Scatterplot with overplotting mitigation

```{r, scatterplot-overplot, cache=TRUE}
diamonds.df = diamonds

ggplot(diamonds.df, aes(carat, price)) +
  geom_point()

ggplot(diamonds.df, aes(carat, price)) +
  geom_point(size = .1)

ggplot(diamonds.df, aes(carat, price)) +
  geom_point(size = .3, shape = 21)


ggplot(diamonds.df, aes(carat, price)) +
  geom_point(size = .3, shape = 21, alpha = .3)

ggplot(diamonds.df %>% sample_n(10000), aes(carat, price)) +
  geom_point(size = .3, shape = 21, alpha = .3)


ggplot(diamonds.df, aes(log(carat), log(price))) +
  geom_point(size = .3, shape = 21, alpha = .3)

ggplot(diamonds.df, aes(log(carat), log(price))) +
  geom_count(show.legend=F, alpha =.3, shape =21)


ggplot(data = mtcars.df, aes( x = disp, y = hp)) +
  geom_point(colour = "grey40", shape = 21)+
  geom_smooth(method = loess, colour = "grey40")+
  geom_smooth(method = lm, se = FALSE, size = .75) +
	geom_smooth(aes(colour = factor(cyl)), 
		method = lm, se = FALSE, size = 1.5)

```



## A matrix of scatterplots
```{r, scatterplot-matrix, echo=FALSE, warning=FALSE, message=FALSE}
library(lattice)
library (car)
library(hexbin)


library (car)
library(lattice)
library(hexbin)
library(ggplot2)
library(dplyr)
mtcars.df = mtcars

names(mtcars)

sub.data = dplyr::select(mtcars.df, -am)

splom(sub.data,
      panel=panel.hexbinplot, #defines baseline features of all plots
      
      upper.panel = function(x, y, ...){
        panel.hexbinplot(x, y, ...) # inserts semitranspartent scatterplot symbols
        panel.abline(h=abs(cor(x, y))/range(y), lwd=1, lty=2, col="grey") # inserts a line with the height proportional to correlation
      },
      
      diag.panel = function(x, ...){
        d <- density(x, na.rm=TRUE)
        yrng <- current.panel.limits()$ylim
        d$y <- with(d, yrng[1] + 0.95 * diff(yrng) * y / max(y))
        panel.lines(d)
        panel.rug(x, ...) # inserts tick marks showing individual data points
        panel.abline(v=mean(x), lwd=1, lty=2, col="grey") # inserts a vertical line for the mean
        diag.panel.splom(x, ...) # sets features of diagnonal
      },
      
      lower.panel = function(x, y, ...){
        panel.hexbinplot(x, y, ...)
        panel.loess(x, y, ..., col = 'red') # inserts a smoothed fit
        panel.lmline(x, y, col="black", lwd=1, lty=2) # inserts a linear regression line
      },
      
      pscale=0, varname.cex=.7 # inserts scale label and sets size of varialble name in diagonal
)

```





<!--chapter:end:03-association.Rmd-->


# Distribution--histograms and density plots{#Distribution}

Placeholder


## Histograms and bin choice
## Density and kernel adjustment 
## Histogram percentage rather than count
## Histogram, density overlay, and normal overlay
## Cummulative density
## Quantile-quantle plot
## Cummulative density
## Distribution: 2-D distribution and overplotting revisited
## Histogram with density and median reference line
## Ridge plot--An array of density plots
## Ridge plot

<!--chapter:end:04-distribution.Rmd-->


# Comparison--barchart and boxplots{#Comparison}

Placeholder


## Graph considerations for communication: aggregation, abstraction, complexity 
### Simple bar chart
## Change order of bars
### Bar chart with error bars
### dotplot and offset range plot
## Set seed and create data
## Plot with offset for mean and error bar
### Statistical significance in context
## Comparing distributions, box, violyn, and sina plot
## Sina plot
### Compare  empirical and theoretical distribution
### Tufte-inspired minimal bar chart
## Comparing across many variables
### Dot plots and reordering
### Point range on x and y
## Point range on x and y
### Tufte boxplot for many variables
## Tufte boxplot
### Tufte-inspired slope graphs {#tufte-slopegraph}
### Parallel coordinate plot with similar items highlighted
## Highlight closest pair of items multidimensional space ##
## Scale variables and calculate distances between cases
## Find the closest vehicle to target vehicle
## Convert to long format for parallel coordinate plot
## Gliphs: Chernof face and radar plots 

<!--chapter:end:05-comparison.Rmd-->


# Proportion--Pie charts and pareto plots{#Proportion}

Placeholder


## Pie and bar chart
## Pareto plot: Whole part and and ranking
## Calculate percent and cumulative percent
## Pareto plot: Individual and cummulative proportion
## Stacked bar chart
## Stacked bar with count: Shows data directly
## Stacked bar with proportion: Abstracts to proportion
## Faceted Bar chart with overall reference distribution
## Rose or Coxcomb plots
## Stacked, dodged and opposed bar chart
## Diversity in Silicon Valley
## Treemaps for whole-part of hierarchy
## Circle packing

<!--chapter:end:06-proportion.Rmd-->


# Fluctuation--timelines {#Fluctuation}

Placeholder


## Multiple time series
## Time series with reference line
## Reference lines in time series
## Cycle plot
## Time series with lines labeled
## Lines with labels rather than legend
## Faceted zoom
## Examples from: https://cran.r-project.org/web/packages/ggforce/vignettes/Visual_Guide.html
## Ridge plot
## Ridge plot
## Stacked area and line graphs
## Temporal heatmap 

<!--chapter:end:07-fluctuation.Rmd-->


# Connection--maps and network plots {#Connection}

Placeholder


## Maps
### Choropleth
### County map
## devtools::install_github("hrbrmstr/ggalt", force=TRUE) # To install development version
## Examples from https://github.com/hrbrmstr/ggalt
## Read and clean data
## Use the maps package to convert maps data to a data frame
## Replace state name with state abbreviations
## Merge county and state shape information with unemployment data
## US county small multiples
## World migration
## Networks
### World migration network
### Hierarchy
## TODO Convert to migration data
## Data describe the class hiearchy of the Flare visualization library
## Same basic data plotted as a circular tree

<!--chapter:end:08-connection.Rmd-->


# Graphical tables--interactive tables, highlights, and sparklines{#Tables}

Placeholder


## Heatmap table
## Table lens with a integrated bar
## Sparkline

<!--chapter:end:09-graphicaltables.Rmd-->


# Polishing and annotating graphs{#Polishing}

Placeholder


## Labeling and annotation
### Annotating data
## Text and rectangle annotation 
## Encircle pooints
### Annotating points and select points
## ggrepel package
## Add annotations to lines rather than legend
### Labels on lines
### Meaningful symbols
### Adding and removing labels: title, axis labels, facet labels, and legends{#AddingRemovingLabels}
## Axis labels, title, and legend
## Subtitle and caption
## Remove labels 
## Facet labels 
### Remove and position one or more legends
### Setting limits on axis and position of graph
### Adjust margin between points and edge of plot area
## Color
### Resources to explain the basis form color choice
### Large and small area colors
## hrbrthemes
## viridis
### Color for large and small areas
## hrbrthemes
### Continuous color scales
### Discrete color mappings
## Themes and theme options
### Remove chart details 
### Predefined themes adjust many elements
## Add man
### Ordering theme layers
## To set for all plots
### Pre-set theme options
### Themes form other packages
## hbrtthemes
## ggthemes
## Saving and printing plots to include in documents
### PNG, JPEG, PDF, and SVG 
## Possible formats:
## PNG--raster format that looks blurry at low resolution  
## PDF--vector format that remains sharp even when zoomed in
## SVG--vector format that remains sharp even when zoomed in
## Saving many plots into a single file
### Combining multiple graphs for publication
### Faceted pagination
## Examples from: https://cran.r-project.org/web/packages/ggforce/vignettes/Visual_Guide.html

<!--chapter:end:10-polishing.Rmd-->

\cleardoublepage 

# Interaction--zoom, annotate, highlight{#Interaction}



```{r, message=FALSE}
library(tidyverse)

```



```{r}
library(ggiraph)

mpg.plot =  ggplot(mpg, aes( x = displ, y = cty, color = hwy))+  	geom_point_interactive(aes(tooltip = model), size = 2) +  	labs(title = "ggiraph: interactive plots")
	
ggiraph(code = 	print(mpg.plot))

```


<!--chapter:end:11-simple_interaction.Rmd-->

\cleardoublepage 

# Shiny--Advanced interactive graphics


```{r, message=FALSE}
library(tidyverse)

```

<!--chapter:end:12-shiny.Rmd-->

\cleardoublepage 

# (APPENDIX) Appendix {-}

## Data sources
https://www.kaggle.com

## Visualization resources

Final commments at end.


<!--chapter:end:13-appendix.Rmd-->

`r if (knitr:::is_html_output()) '# References {-}'`

```{r include=FALSE}
# generate a BibTeX database automatically for some R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```


<!--chapter:end:14-references.Rmd-->

